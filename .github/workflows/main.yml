name: Deploy OWASP WordPress VM

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login using azure_credentials
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -------------------------------
    # Create Resource Group (idempotent)
    # -------------------------------
    - name: Create Resource Group if not exists
      run: |
        if ! az group exists --name owasp-wp-rg; then
          echo "Creating resource group..."
          az group create --name owasp-wp-rg --location centralindia
        else
          echo "Resource group already exists. Skipping."
        fi

    # -------------------------------
    # Deploy VM (idempotent)
    # -------------------------------
    - name: Deploy VM if not exists
      run: |
        if ! az vm show --resource-group owasp-wp-rg --name owaspwpvm >/dev/null 2>&1; then
          echo "Creating VM..."
          az vm create \
            --resource-group owasp-wp-rg \
            --name owaspwpvm \
            --image Ubuntu2204 \
            --size Standard_B1s \
            --admin-username azureuser \
            --admin-password "${{ secrets.VM_ADMIN_PASSWORD }}" \
            --authentication-type password \
            --custom-data cloud-init.txt \
            --public-ip-sku Standard
        else
          echo "VM already exists. Skipping."
        fi

        --query "[?contains(destinationPortRange, '22')]"

    # -------------------------------
    # Output Public IP
    # -------------------------------
    - name: Output Public IP
      run: |
        IP=$(az vm show -d -g owasp-wp-rg -n owaspwpvm --query publicIps -o tsv)
        echo "======================================="
        echo " WordPress URL: http://$IP"
        echo " SSH: ssh azureuser@$IP"
        echo " Password is stored in GitHub Secret"
        echo "======================================="
