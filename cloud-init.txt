#cloud-config
package_update: true
packages:
  - apache2
  - mysql-server
  - php
  - php-mysql
  - php-curl
  - php-gd
  - php-mbstring
  - php-xml
  - php-xmlrpc
  - php-soap
  - php-intl
  - php-zip
  - wget
  - unzip

runcmd:
  - systemctl enable apache2
  - systemctl start apache2

  # Configure MySQL
  - mysql -e "CREATE DATABASE wpdb;"
  - mysql -e "CREATE USER 'wpuser'@'localhost' IDENTIFIED BY 'Password123!';"
  - mysql -e "GRANT ALL PRIVILEGES ON wpdb.* TO 'wpuser'@'localhost';"
  - mysql -e "FLUSH PRIVILEGES;"

  # Install WordPress (OWASP vulnerable version)
  - wget https://wordpress.org/wordpress-5.0.zip -P /tmp/
  - unzip /tmp/wordpress-5.0.zip -d /tmp/
  - cp -r /tmp/wordpress/* /var/www/html/
  - chown -R www-data:www-data /var/www/html
  - chmod -R 755 /var/www/html

  # Auto-config wp-config.php
  - cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
  - sed -i "s/database_name_here/wpdb/" /var/www/html/wp-config.php
  - sed -i "s/username_here/wpuser/" /var/www/html/wp-config.php
  - sed -i "s/password_here/Password123!/" /var/www/html/wp-config.php

  # Enable .htaccess overrides
  - sed -i 's/AllowOverride None/AllowOverride All/' /etc/apache2/apache2.conf
  - systemctl restart apache2

  #####################################################
  # üìå Install OWASP Vulnerable Plugins
  #####################################################

  # Create plugin directory if missing
  - mkdir -p /var/www/html/wp-content/plugins/

  # 1Ô∏è‚É£ File Manager 6.0 (Unauthenticated RCE)
  - wget https://github.com/wp-plugins/wp-file-manager/archive/refs/tags/6.0.zip -O /tmp/filemanager.zip
  - unzip /tmp/filemanager.zip -d /tmp/
  - cp -r /tmp/wp-file-manager-6.0 /var/www/html/wp-content/plugins/file-manager

  # 2Ô∏è‚É£ DVWA-style Unrestricted File Upload plugin
  - mkdir -p /var/www/html/wp-content/plugins/unsafe-upload
  - cat << 'EOF' > /var/www/html/wp-content/plugins/unsafe-upload/unsafe-upload.php
<?php
/*
Plugin Name: Unsafe File Upload
Description: Demonstrates unrestricted file upload (OWASP A6).
Version: 1.0
*/
if ($_FILES) {
    move_uploaded_file($_FILES['file']['tmp_name'], ABSPATH.'/'.$_FILES['file']['name']);
    echo "Uploaded!";
}
function upload_form(){
    echo '<form method="POST" enctype="multipart/form-data">
            <input type="file" name="file"/>
            <input type="submit" value="Upload"/>
          </form>';
}
add_shortcode("upload_form","upload_form");
?>
EOF

  # 3Ô∏è‚É£ XSS Demo Plugin
  - mkdir -p /var/www/html/wp-content/plugins/xss-demo
  - cat << 'EOF' > /var/www/html/wp-content/plugins/xss-demo/xss-demo.php
<?php
/*
Plugin Name: XSS Demo Plugin
Description: Demonstrates reflected XSS via shortcode.
Version: 1.0
*/
function xss_test(){
    $msg = $_GET['msg'];
    return "<h3>User Message: $msg</h3>";
}
add_shortcode("xss", "xss_test");
?>
EOF

  # Set permissions
  - chown -R www-data:www-data /var/www/html/wp-content/plugins
  - chmod -R 755 /var/www/html/wp-content/plugins

final_message: "OWASP WordPress VM with vulnerable plugins deployed!"
