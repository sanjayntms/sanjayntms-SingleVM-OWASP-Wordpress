#cloud-config
package_update: true
packages:
  - apache2
  - mysql-server
  - php
  - php-mysql
  - php-curl
  - php-gd
  - php-mbstring
  - php-xml
  - php-xmlrpc
  - php-soap
  - php-intl
  - php-zip
  - wget
  - unzip

runcmd:
  - systemctl enable apache2
  - systemctl start apache2

  # Configure MySQL
  - mysql -e "CREATE DATABASE wpdb;"
  - mysql -e "CREATE USER 'wpuser'@'localhost' IDENTIFIED BY 'Password123!';"
  - mysql -e "GRANT ALL PRIVILEGES ON wpdb.* TO 'wpuser'@'localhost';"
  - mysql -e "FLUSH PRIVILEGES;"

  # Install WordPress (OWASP vulnerable version)
  - wget https://wordpress.org/wordpress-5.0.zip -P /tmp/
  - unzip /tmp/wordpress-5.0.zip -d /tmp/
  - cp -r /tmp/wordpress/* /var/www/html/
  - chown -R www-data:www-data /var/www/html
  - chmod -R 755 /var/www/html

  # Auto-config wp-config.php
  - cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
  - sed -i "s/database_name_here/wpdb/" /var/www/html/wp-config.php
  - sed -i "s/username_here/wpuser/" /var/www/html/wp-config.php
  - sed -i "s/password_here/Password123!/" /var/www/html/wp-config.php

  # Enable .htaccess for permalinks
  - sed -i 's/AllowOverride None/AllowOverride All/' /etc/apache2/apache2.conf
  - systemctl restart apache2

final_message: "OWASP WordPress VM deployment complete!"
